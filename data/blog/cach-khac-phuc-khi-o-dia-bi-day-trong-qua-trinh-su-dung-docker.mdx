---
title: CÃ¡ch kháº¯c phá»¥c khi á»• Ä‘Ä©a bá»‹ Ä‘áº§y trong quÃ¡ trÃ¬nh sá»­ dá»¥ng Docker?
summary: "Trong quÃ¡ trÃ¬nh sá»­ dá»¥ng Docker lÃ¢u dÃ i, báº¡n cÃ³ thá»ƒ sáº½ gáº·p nhiá»u tÃ¬nh huá»‘ng khiáº¿n á»• Ä‘Ä©a bá»‹ Ä‘áº§y khi sá»­ dá»¥ng. HÃ£y theo dÃµi bÃ i viáº¿t Ä‘á»ƒ biáº¿t cÃ¡ch kháº¯c phá»¥c váº¥n Ä‘á» nÃ y cÃ¹ng mÃ¬nh nhÃ© ^^"
date: '2023-12-04'
draft: false
tags: ['DevOps', 'Docker', 'Container', 'Logs']
authors: ['anhnmt']
layout: PostLayout
---

<TOCInline toc={props.toc} asDisclosure />

Náº¿u báº¡n thÆ°á»ng xuyÃªn build image báº±ng Docker, thÃ¬ cháº¯c cÃ¡c báº¡n cÅ©ng Ä‘á»ƒ Ã½ khi build láº¡i thÃ¬ láº§n sau thÆ°á»ng sáº½ nhanh hÆ¡n pháº§n trÆ°á»›c. Nhanh nhÆ° váº­y Ä‘Ã³ lÃ  do Docker Ä‘Ã£ cache láº¡i Ä‘á»ƒ quÃ¡ trÃ¬nh build image cá»§a chÃºng ta Ä‘Æ°á»£c nhanh hÆ¡n.
Táº¥t nhiÃªn cÃ¡i gÃ¬ cÅ©ng cÃ³ cÃ¡i giÃ¡ cá»§a nÃ³ ^^. MÃ¬nh cÅ©ng Ä‘Ã£ tá»«ng gáº·p trÆ°á»ng há»£p nhÆ° váº­y khi triá»ƒn khai dá»± Ã¡n á»Ÿ cÃ´ng ty, mÃ¬nh dá»±ng 1 server GitHub Action self-hosted Ä‘á»ƒ cháº¡y CI (Continuous Innovation) build image má»›i nháº¥t tá»« Repo má»—i khi Ä‘áº©y code vÃ o nhÃ¡nh `prod`, `staging` hoáº·c `dev`.

QuÃ¡ trÃ¬nh nÃ y hoáº¡t Ä‘á»™ng cÅ©ng Ä‘Æ°á»£c gá»i lÃ  á»•n Ä‘á»‹nh cho Ä‘áº¿n khi 1 váº¥n Ä‘á» xáº£y ra ğŸ˜’

```bash
Error: no space left on device
```

Lá»‘i bÃªn trÃªn chá»‰ mang tÃ­nh cháº¥t minh hoáº¡, nhÆ°ng Ä‘áº¡i loáº¡i lÃ  lá»—i tráº£ vá» cÃ³ dáº¡ng `no space left on device`.
Ngay láº­p tá»©c mÃ¬nh káº¿t ná»‘i vÃ o server Ä‘á»ƒ xem tÃ¬nh hÃ¬nh ra sao. Sau Ä‘Ã³ cháº¡y lá»‡nh `df` Ä‘á»ƒ kiá»ƒm tra disk cÃ²n bao nhiÃªu % á»• Ä‘Ä©a trá»‘ng.

```bash
ubuntu@builder:~$ df -h
Filesystem      Size  Used Avail Use% Mounted on
tmpfs           791M  3.3M  787M   1% /run
/dev/sda2        98G   98G   0     99% /
tmpfs           3.9G     0  3.9G   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           791M  4.0K  791M   1% /run/user/1000
ubuntu@builder:~$     
```

(Káº¿t quáº£ Ä‘Ã£ Ä‘Æ°á»£c mÃ¬nh cháº¿ chÃ¡o láº¡i ğŸ˜, nhÆ°ng Ä‘áº¡i loáº¡i lÃ  sáº½ cÃ³ dáº¡ng nhÆ° váº­y)
NhÃ¬n káº¿t quáº£ bÃªn trÃªn cháº¯c cÃ¡c báº¡n cÅ©ng sáº½ tháº¥y `/dev/sda2` Ä‘ang Ä‘áº§y 99%. khi Ä‘áº§y thÃ¬ cá»™t `Used` sáº½ cao, `Avail` sáº½ tháº¥p vÃ  cá»™t `Use%` sáº½ hiá»ƒn thá»‹ % sá»­ dá»¥ng á»• Ä‘Ä©a

Tiáº¿p tá»¥c kiá»ƒm tra kÃ­ch thÆ°á»›c cá»§a tá»«ng thÆ° má»¥c tá»« thÆ° má»¥c root

```bash
ubuntu@builder:~$ sudo du -h --max-depth 1 /
```

Tháº¥y thÆ° má»¥c `/var` lá»›n nháº¥t, check tiáº¿p bÃªn trong thÆ° má»¥c Ä‘Ã³.

```bash
ubuntu@builder:~$ sudo du -h --max-depth 1 /var
```

Tiáº¿p tá»¥c vá»›i thÆ° má»¥c `/var/lib` thÃ¬ tÃ´i tÃ¬m ra thÆ° má»¥c `/var/lib/docker` náº·ng nháº¥t, cá»¥ thá»ƒ lÃºc Ä‘áº¥y khoáº£ng 80GB.

```bash
ubuntu@builder:~$ sudo du -h --max-depth 1 /var/lib/docker
4.0K	/var/lib/docker/runtimes
40G   /var/lib/docker/overlay2
148K	/var/lib/docker/volumes
4.9M	/var/lib/docker/containers
4.0K	/var/lib/docker/tmp
4.0K	/var/lib/docker/swarm
152K	/var/lib/docker/network
56M	  /var/lib/docker/image
39M	  /var/lib/docker/buildkit
16K	  /var/lib/docker/plugins
40G	  /var/lib/docker
```

Ok váº­y Ä‘Ã£ tÃ¬m Ä‘Æ°á»£c nguyÃªn nhÃ¢n lÃ  do docker, bÆ°á»›c tiáº¿p theo lÃ  xem cÃ¡i gÃ¬ dá»n dáº¹p Ä‘Æ°Æ¡c thÃ¬ dá»n dáº¹p. CÃ¡c thá»© mÃ¬nh nghÄ© cÃ³ thá»ƒ dá»n dáº¹p Ä‘Æ°á»£c bao gá»“m:
- Log cá»§a cÃ¡c container
- CÃ¡c volume khÃ´ng cÃ²n Ä‘Æ°á»£c sá»­ dá»¥ng
- CÃ¡c container Ä‘Ã£ stopped
- CÃ¡c image mÃ  khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng
- Build cache

TÃ¬m Ä‘Æ°á»£c cÃ¡c thá»© cáº§n dá»n dáº¹p rá»“i thÃ¬ chÃºng ta báº¯t Ä‘áº§u dá»n dáº¹p thÃ´i.

## XoÃ¡ cÃ¡c `volume` khÃ´ng sá»­ dá»¥ng ná»¯a

CÃ¢u lá»‡nh dá»n dáº¹p cÃ¡c `volume` mÃ  khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng ná»¯a.
```
docker volume prune -a -f
```

## XoÃ¡ cÃ¡c `image` khÃ´ng sá»­ dá»¥ng ná»¯a

CÃ¢u lá»‡nh dá»n dáº¹p cÃ¡c `image` mÃ  khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng ná»¯a.
```
docker image prune -a -f
```

## XoÃ¡ cÃ¡c `container` khÃ´ng sá»­ dá»¥ng ná»¯a

CÃ¢u lá»‡nh dá»n dáº¹p cÃ¡c `container` mÃ  khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng ná»¯a.
```
docker container prune -a -f
```

## XoÃ¡ cÃ¡c `builder` khÃ´ng sá»­ dá»¥ng ná»¯a

CÃ¢u lá»‡nh dá»n dáº¹p cÃ¡c `builder` mÃ  khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng ná»¯a.
(Server builder cá»§a mÃ¬nh náº·ng nháº¥t pháº§n nÃ y, vÃ¬ pháº£i build image liÃªn tá»¥c dáº«n tá»›i cache lÃ m Ä‘áº§y á»• cá»©ng)

```
docker builder prune -a -f
```

## CÃ¢u lá»‡nh giÃºp dá»n dáº¹p nhanh chÃ³ng `system prune`

PhiÃªn báº£n sau nÃ y cá»§a docker cÃ³ lá»‡nh `docker system prune` sáº½ tá»± Ä‘á»™ng lÃ m kha khÃ¡ cÃ¡c viá»‡c dá»n dáº¹p cho chÃºng ta.

```
ubuntu@builder:~$ docker system prune
WARNING! This will remove:
  - all stopped containers
  - all networks not used by at least one container
  - all dangling images
  - all dangling build cache

Are you sure you want to continue? [y/N] y
Deleted Networks:
docker-network_default
Deleted build cache objects:
98jlfzkgw1hjfdk22sd5460x5
3o8xbgqhl6e49n3illj8fenid
o692cdjs4pm8ni4l4rg8v4hpw
pobyjug26w7kddhf68st2sj5t
p3imtyiehrh0pqfptsyfyftaj
...
Total reclaimed space: 80.17GB
```

Hoáº·c cháº¡y lá»‡nh xoÃ¡ táº¥t cáº£

```
docker system prune -a -f
```

## XoÃ¡ cÃ¡c container logs

Thá»© chiáº¿m dung lÆ°á»£ng á»• Ä‘Ä©a tiáº¿p theo lÃ  Docker Json Logs, máº·c Ä‘á»‹nh khi cÃ i Docker thÃ¬ toÃ n bá»™ logs cá»§a container sáº½ Ä‘Æ°á»£c Docker lÆ°u á»Ÿ thÆ° má»¥c /var/lib/docker/containers/* á»Ÿ dáº¡ng json, náº¿u ta khÃ´ng thÆ°á»ng xuyÃªn xÃ³a logs á»Ÿ thÆ° má»¥c nÃ y thÃ¬ nÃ³ sáº½ lÃªn tá»›i vÃ i chá»¥c hoáº·c vÃ i trÄƒm GB.

Äá»ƒ xÃ³a logs á»Ÿ thÆ° má»¥c nÃ y ta cÃ³ vÃ i cÃ¡ch sau:
- Cáº¥u hÃ¬nh crontab
- DÃ¹ng logrotate
- Giá»›i háº¡n dung lÆ°á»£ng logs cá»§a container

Dá»n dáº¹p log cá»§a container, Ä‘Æ¡n giáº£n lÃ  lÃ m nÃ³ trá»‘ng trÆ¡n. (Sá»­ dá»¥ng quyá»n `root` náº¿u bá»‹ lá»—i `Permission denied`)

### XÃ³a thá»§ cÃ´ng vá»›i crontab

```
for f in /var/lib/docker/containers/*/*-json.log
do
  cat /dev/null > \$f
done
```

Cáº¥u hÃ¬nh crontab:

```
# daily
sudo -s

cat <<EOF > /etc/cron.daily/clear-container-logs
#!/bin/sh
for f in /var/lib/docker/containers/*/*-json.log
do
  cat /dev/null > \$f
done
EOF

chmod +x /etc/cron.daily/clear-container-logs
```

### Tá»± Ä‘á»™ng vá»›i logrotate

Náº¿u báº¡n muá»‘n giá»¯ láº¡i logs thÃ¬ cÃ³ thá»ƒ dÃ¹ng `logrotate` Ä‘á»ƒ tá»± Ä‘á»™ng giáº£m dung lÆ°á»£ng logs cá»§a Docker.

Háº§u háº¿t cÃ¡c Linux Distro Ä‘á»u cÃ i sáºµn `logrotate`, cáº¥u hÃ¬nh logrotate cho tá»‡p tin logs cá»§a Docker ráº¥t Ä‘Æ¡n giáº£n, ta táº¡o tá»‡p tin `logrotate-container` á»Ÿ thÆ° má»¥c `/etc/logrotate.d` vÃ  dÃ¡n cáº¥u hÃ¬nh á»Ÿ dÆ°á»›i vÃ o:

```
/var/lib/docker/containers/*/*.log {
  rotate 7
  daily
  compress
  missingok
  delaycompress
  copytruncate
}
```

Cháº¡y thá»­:

```
logrotate -fv /etc/logrotate.d/logrotate-container
```

MÄƒc Ä‘á»‹nh logrotate cÃ³ sáºµn crontab náº±m á»Ÿ thÆ° má»¥c `/etc/cron.daily` Ä‘á»ƒ cháº¡y logrotate háº±ng ngÃ y nÃªn ta khÃ´ng cáº§n pháº£i cáº¥u hÃ¬nh crontab thÃªm.

### Giá»›i háº¡n dung lÆ°á»£ng logs cá»§a container

Tá»« phiÃªn báº£n 1.8 trá»Ÿ Ä‘i thÃ¬ Docker cÃ³ sáºµn chá»©c nÄƒng logrotate cho json logs. Khi cháº¡y container ta thÃªm vÃ o thuá»™c tÃ­nh `--log-opt` vÃ o Ä‘á»ƒ giá»›i háº¡n dung lÆ°á»£ng logs cá»§a container.

```
docker run --log-driver json-file --log-opt max-size=10m nginx
```

Náº¿u ta cáº§n cáº¥u hÃ¬nh cho toÃ n bá»™ container thÃ¬ thÃªm cáº¥u hÃ¬nh sau vÃ o daemon.json, náº±m á»Ÿ thÆ° má»¥c `/etc/docker/` trÃªn Linux vÃ  á»Ÿ thÆ° má»¥c `C:\ProgramData\docker\config\` trÃªn Windows.

```json:daemon.json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

## Káº¿t luáº­n

TrÃªn Ä‘Ã¢y lÃ  1 sá»‘ cÃ¡ch Ä‘á»ƒ trÃ¡nh vÃ  kháº¯c phá»¥c khi á»• Ä‘Ä©a bá»‹ Ä‘áº§y trong quÃ¡ trÃ¬nh há»c táº­p vÃ  sá»­ dá»¥ng Docker. CÃ¡ch kháº¯c phá»¥c tuy Ä‘Æ¡n giáº£n nhÆ°ng váº¥n Ä‘á» nÃ y ráº¥t quan trá»ng nÃªn cÃ¡c báº¡n hÃ£y cáº©n tháº­n chá»n cÃ¡ch phÃ¹ há»£p Ä‘á»ƒ cáº¥u hÃ¬nh cho mÃ¡y chá»§ cá»§a mÃ¬nh nhÃ© ^^.

## Ná»™i dung tham kháº£o
- QuÃ¢n Huá»³nh - [LÃ m tháº¿ nÃ o Ä‘á»ƒ trÃ¡nh á»• Ä‘Ä©a bá»‹ Ä‘áº§y khi xÃ i Docker?](https://devopsvn.tech/devops/lam-the-nao-de-tranh-o-dia-bi-day-khi-xai-docker)
- Nguyen Minh Tuan - [Háº¿t dung lÆ°á»£ng disk do cháº¡y Docker trong thá»i gian dÃ i](https://viblo.asia/p/het-dung-luong-disk-do-chay-docker-trong-thoi-gian-dai-oK9Vyze94QR)
- [Docker: How to clear the logs properly for a Docker container?](https://stackoverflow.com/questions/42510002/docker-how-to-clear-the-logs-properly-for-a-docker-container)